<!--
<HTML>
<BODY>

<canvas id='lab02' height='500' width='500' style='border:1px solid'>
</canvas>
<canvas id='lab02_2' height='500' width='500' style='border:1px solid'>
</canvas>

<script>
    let canvas = document.getElementById('lab02');
    let ctx = canvas.getContext('2d');
    let canvas2 = document.getElementById('lab02_2');
    let ctx2 = canvas2.getContext('2d');

    function line(ctx, x0, y0, x1, y1) {
        let delta = 2*(y1-y0);
        let eps = 0;
        let y = y0;
        let scale = 1;

        for (let x = x0; x <= x1; x++) {
            eps += delta;
            if (eps >= (x1-x0)) {
                eps -= 2*(x1-x0);
                y++;
            }
            ctx.fillRect(x*scale, y*scale, 1*scale, 1*scale);
        }
    }


    let img = new Image();
    img.crossOrigin = "anonymus";

    img.src = 'https://lh3.googleusercontent.com/proxy/D6lBUzrnb3r8Z47y1i-wk7hy4ub4_vKkojAiw_mKI79zViYA4h0F-kkWBu6Xy7Ngg7DAAQ_vc1U';
    img.onload = function() {
        ctx.drawImage(img, -350, 0);

        let img_data = ctx.getImageData(0, 0, canvas.width, canvas.height);
        console.log(img_data);


        let points = [];

        let img_data2 = ctx2.createImageData(canvas.width, canvas.height);
        for (let i=0; i<canvas.height; i++) {
            for (let j=0; j<canvas.width; j++) {
                if (img_data.data[4*(i*canvas.width+j)+0] < 10 &&
                    img_data.data[4*(i*canvas.width+j)+1] < 10 &&
                    img_data.data[4*(i*canvas.width+j)+2] < 10)
                {
                    for (let k=0; k<3; k++) {
                        img_data2.data[4*(i*canvas.width+j)+k] = 255;
                    }
                    points.push({x:j, y:i});
                }
                img_data2.data[4*(i*canvas.width+j)+3] = 255;
            }
        }
        ctx2.putImageData(img_data2, 0, 0);


        console.log(points);
        const partition=12;		// Разбиение плоскости углами
        const threshold = 180; // Порог для принятия линии
        let k_array = [];
        let params2d = [];

        for (let i=0; i<partition; i++) {
            k_array.push(i*(Math.PI/partition));
            params2d.push([]);
        }

        for (let i=0; i<partition; i++) {
            for (let j=0; j<points.length; j++) {
                params2d[i].push(points[j].y - k_array[i]*points[j].x);
            }
        }

        let d = 2;
        for (let i=0; i<partition; i++) {
            params2d[i].sort();
            let base;
            let j=0;
            while (j<params2d[i].length) {
                let count = 0;
                base = params2d[i][j];
                while (params2d[i][j]<base+d && j<params2d[i].length) {

                    count++;
                    j++;
                }
                console.log("k= "+i+" b= "+base+" count= "+count);
                ctx2.fillStyle="#00FF00";
                if (count > threshold) {
                    line(ctx2, 0, base,
                        canvas2.width, k_array[i]*canvas2.width+base);
                }
            }

        }

        console.log(params2d);


    }


</script>




</BODY>
</HTML>-->

<HTML>
<BODY>

<canvas width='1000' , height='1000' , id='canvas_1'></canvas>

<script>
    let canvas = document.getElementById("canvas_1");
    let ctx = canvas.getContext('2d');

    class Point {

        constructor(x, y) {
            this.x = x;
            this.y = y;
            console.log('construct:',x,y);
        }
        drawDot() {
            console.log('draw:',this.x,this.y);
            ctx.fillRect(this.x,this.y,2,2);
        }
        x = 0;
        y = 0;
    }

    let draw = false;
    let drawLine = false;

    function intersect(ctx, ax, ay, bx, by, xp1, yp1, xp2, yp2) {
        let t = ((ay - yp1) * (xp2 - xp1) - (ax - xp1) * (yp2 - yp1)) / ((bx - ax) * (yp2 - yp1) - (by - ay) * (xp2 - xp1));

        let prod = - (bx - ax) * (yp2 - yp1) + (by - ay) * (xp2 - xp1);
        let dir = 1;
        if (prod < 0)
            dir = -1;
        // ctx.fillStyle = "#FF0000";
        console.log('t = ', t);
        console.log('prod = ', prod);
        return {t, dir};
    }

    function line(ctx, x0, y0, x1, y1) {
        const dX = (x1 - x0 >= 0 ? 1 : -1);
        const dY = (y1 - y0 >= 0 ? 1 : -1);

        const absDeltaX = Math.abs(x1 - x0);
        const absDeltaY = Math.abs(y1 - y0);

        let length = Math.max(absDeltaX, absDeltaY) + 1;

        let error = 0;
        if (length === 0) {
            ctx.fillRect(x0, y0, 1, 1);
        }
        let x = x0;
        let y = y0;
        if (absDeltaY <= absDeltaX) {
            let cnt = 0;
            while (length-- > 0) {
                error += 2 /** dY*/ * absDeltaY;
                if (cnt === 0) {
                    // ctx.fillStyle = "#1c0496";
                    // ctx.fillRect(x, y, 3, 3);
                    cnt++
                    ctx.fillStyle = "#c8b400";
                    continue;
                }
                if (error >= absDeltaX) {
                    y += dY
                    error -= 2 * absDeltaX;
                }
                x += dX;
                ctx.fillRect(x, y, 1, 1);
            }

        } else {
            let cnt = 0;
            while (length-- > 0) {
                error += 2 * absDeltaX;
                if (cnt === 0) {
                    // ctx.fillStyle = "#ff0098";
                    // ctx.fillRect(x, y, 3, 3);
                    cnt++
                    ctx.fillStyle = "#c953e5";
                    continue;
                }
                if (error >= absDeltaY) {
                    x += dX
                    error -= 2 * absDeltaY;
                }
                y += dY;
                ctx.fillRect(x, y, 1, 1);
            }
        }
    }

    let pointIndex = 0;
    let points = [];
    let mainPoints = [];
    canvas.addEventListener('click', function (e) {
        if (!draw) {
            let newPoint = new Point(e.offsetX, e.offsetY);
            newPoint.drawDot();
            points.push(newPoint);
            console.dir(newPoint);
        }
        if (drawLine) {
            let newPoint = new Point(e.offsetX, e.offsetY);
            // newPoint.drawDot();
            mainPoints.push(newPoint);
            console.dir(newPoint);
            pointIndex++;
            if (pointIndex === 2) {
                console.log('DRAW DOTS OF INTERSECTIONS');
                let N = points.length;
                let positive = [];
                let negative = [];
                let xm1 = mainPoints[0].x;
                let ym1 = mainPoints[0].y;
                let xm2 = mainPoints[1].x;
                let ym2 = mainPoints[1].y;
                for (let i = 0; i < N; i++) {
                    // if(i!=(N-1))

                    let x11 = points[i].x;
                    let y11 = points[i].y;
                    let x22 = points[(i + 1) % (points.length)].x;
                    let y22 = points[(i + 1) % (points.length)].y;
                    let res = intersect(ctx, xm1, ym1, xm2, ym2, x11, y11, x22, y22);
                    let tx = res.t * (xm2-xm1) + xm1;
                    let ty = res.t * (ym2-ym1) + ym1;

                    if(res.dir === -1)
                        negative.push(res.t);
                    else
                        positive.push(res.t);
                    console.log('T',res.t,'tx',tx,'ty',ty);
                    /*ctx.fillStyle = '#0029ff';
                    ctx.fillRect(tx,ty,6,6);
                    ctx.fillStyle = '#000000';*/
                }
                console.dir(positive);
                console.dir(negative);
                positive.push(0);
                negative.push(1);
                let start = positive.sort(function (a, b) {
                    return b-a;
                })[0];
                let end = negative.sort(function (a, b) {
                    return a-b;
                })[0];

                if(0 < start && start < end && end < 1) {
                    console.log('FIRST VARIANT');
                    line(ctx,start*(xm2-xm1)+xm1,start*(ym2-ym1)+ym1,end*(xm2-xm1)+xm1,end*(ym2-ym1)+ym1);
                }
                if(0 <= start && start <= end && end <= 1) {
                    console.log('SECOND_1 VARIANT');
                    if(start === 0) {
                        line(ctx,mainPoints[0].x,mainPoints[0].y,end*(xm2-xm1)+xm1,end*(ym2-ym1)+ym1);
                    }
                    if(end === 1) {
                        console.log('SECOND_2 VARIANT');
                        line(ctx,start*(xm2-xm1)+xm1,start*(ym2-ym1)+ym1,mainPoints[1].x,mainPoints[1].y);
                    }
                }
                if(end < start) {
                    console.log('THIRD VARIANT');
                    line(ctx,mainPoints[0].x,mainPoints[0].y,mainPoints[1].x,mainPoints[1].y);
                }
                console.dir(positive);
                console.dir(negative);
                console.log('start_t',start,'end_t',end);

                pointIndex = 0;
                mainPoints = [];
            }
        }
        /*
        if (pointIndex === 0) {
            x0 = e.offsetX;
            y0 = e.offsetY;
            pointIndex = 1;
        } else {
            x1 = e.offsetX;
            y1 = e.offsetY;
            /!*  ctx.fillStyle = "#00FF00";
              ctx.fillRect(x0,y0,5,5);
              ctx.fillStyle = "#ff0000";
              ctx.fillRect(x1,y1,5,5);*!/
            line(ctx, x0, y0, x1, y1);
            pointIndex = 0;
        }*/
    });


    canvas.addEventListener('contextmenu', function (e) {
        if (!draw) {
            draw = true;
            for (let i = 0; i < points.length; i++) {
                let x11 = points[i].x;
                let y11 = points[i].y;
                let x22 = points[(i + 1) % (points.length)].x;
                let y22 = points[(i + 1) % (points.length)].y;
                console.log(x11, y11, x22, y22);
                line(ctx, x11, y11, x22, y22);
            }
            drawLine = true;
        }
    });


</script>
</BODY>
</HTML>


